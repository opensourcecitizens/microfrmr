# Dockerfile

# x86-64 :
# docker buildx build . -t mtini.io/nodejdk17androidndk:0.0.1-x86-64 -f ./nodejdk17androidndk-Dockerfile --platform linux/x86-64
# amd64
# docker buildx build . -t mtini.io/nodejdk17androidndk:0.0.1-amd64 -f ./nodejdk17androidndk-Dockerfile --platform linux/amd64
#arm64-v8a
# docker buildx build . -t mtini.io/nodejdk17androidndk:0.0.1-arm64-v8a -f ./nodejdk17androidndk-Dockerfile --platform linux/arm64-v8a
#arm64-v86
# docker buildx build . -t mtini.io/nodejdk17androidndk:0.0.1-arm64-v86 -f ./nodejdk17androidndk-Dockerfile --platform linux/arm64-v86
FROM node:22.9.0

ARG TARGETPLATFORM
RUN echo "Target platform: $TARGETPLATFORM"

ARG TARGETARCH
RUN echo "Target architecture: $TARGETARCH"

WORKDIR /
#
# no arm openjdk:18-ea-11-jdk-alpine3.13
# Install JDK 17
RUN apt-get update && apt-get install -y --no-install-recommends \
    openjdk-17-jdk && \
    rm -rf /var/lib/apt/lists/*


# Set environment variables
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-${TARGETARCH}
ENV PATH="${JAVA_HOME}/bin:${PATH}"
ENV ANDROID_SDK_TOOLS_VERSION="9477386"

RUN npm install -g npm@10.2.3

# prep ANDROID_HOME
RUN apt-get install -y unzip make

# COMMANDLINE TOOLS INSTALL
RUN wget https://dl.google.com/android/repository/commandlinetools-linux-7302050_latest.zip
RUN mkdir -p Android/cmdline-tools
RUN unzip commandlinetools-linux-*.zip -d Android/cmdline-tools
RUN mv Android/cmdline-tools/cmdline-tools Android/cmdline-tools/latest

ENV ANDROID_HOME=/Android
# Make sure emulator path comes before tools. Had trouble on Ubuntu with emulator from /tools being loaded
# instead of the one from /emulator
ENV PATH="$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/cmdline-tools/latest:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH"

# don't need this anymore
# sdkmanager --sdk_root=${ANDROID_HOME} "tools"

RUN sdkmanager --update
RUN sdkmanager --list
# find current version
RUN sdkmanager --list | grep build-tools
#testing this emulator download - failing here because package cannot be found
RUN sdkmanager "emulator"
RUN sdkmanager "build-tools;30.0.3" "platform-tools" "platforms;android-30" "tools"
#RUN sdkmanager "build-tools;34.0.0" "platform-tools" "platforms;android-34" "tools"
RUN sdkmanager --licenses